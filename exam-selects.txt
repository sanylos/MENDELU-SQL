//Kolik sudů piva bylo celkem vystaveno v restauraci Labská Bašta?
SELECT SUM(pocet_kusu) AS celkovy_pocet_sudů
FROM p3_vystav
JOIN p3_restaurace ON p3_vystav.id_restaurace = p3_restaurace.id_restaurace
WHERE p3_restaurace.nazev = 'Labská Bašta';

//Pro jednotlivé kraje určete pivovar z daného kraje, který vystavil největší objem piva.
WITH TotalVolumePerBrewery AS (
    SELECT 
        K.ID_KRAJE,
        K.NAZEV AS KRAJ,
        PIV.ID_PIVOVARU,
        PIV.NAZEV AS PIVOVAR,
        SUM(V.POCET_KUSU * TOB.OBJEM_V_LITRECH) AS CELKOVY_OBJEM
    FROM 
        VYSTAV V
    JOIN PIVA PI ON V.ID_PIVA = PI.ID_PIVA
    JOIN PIVOVARY PIV ON PI.ID_PIVOVARU = PIV.ID_PIVOVARU
    JOIN ADRESY A ON PIV.ID_ADRESY = A.ID_ADRESY
    JOIN SMEROVACI_CISLA SC ON A.PSC = SC.PSC
    JOIN OBCE O ON SC.ID_OBCE = O.ID_OBCE
    JOIN KRAJE K ON O.ID_KRAJE = K.ID_KRAJE
    JOIN TYPY_OBALU TOB ON V.ID_TYPU_OBALU = TOB.ID_TYPU_OBALU
    GROUP BY 
        K.ID_KRAJE,
        K.NAZEV,
        PIV.ID_PIVOVARU,
        PIV.NAZEV
),
MaxVolumePerRegion AS (
    SELECT 
        ID_KRAJE,
        MAX(CELKOVY_OBJEM) AS MAX_OBJEM
    FROM 
        TotalVolumePerBrewery
    GROUP BY 
        ID_KRAJE
)
SELECT 
    TV.KRAJ,
    TV.PIVOVAR,
    TV.CELKOVY_OBJEM
FROM 
    TotalVolumePerBrewery TV
JOIN 
    MaxVolumePerRegion MR ON TV.ID_KRAJE = MR.ID_KRAJE AND TV.CELKOVY_OBJEM = MR.MAX_OBJEM;

//Pro jednotlivé kraje určete dny s nejvyšším vystaveným objemem.
WITH DailyVolumePerRegion AS (
    SELECT 
        K.ID_KRAJE,
        K.NAZEV AS KRAJ,
        TRUNC(V.CAS_VYSTAVENI) AS DEN,
        SUM(V.POCET_KUSU * TOB.OBJEM_V_LITRECH) AS CELKOVY_OBJEM
    FROM 
        VYSTAV V
    JOIN PIVA PI ON V.ID_PIVA = PI.ID_PIVA
    JOIN PIVOVARY PIV ON PI.ID_PIVOVARU = PIV.ID_PIVOVARU
    JOIN ADRESY A ON PIV.ID_ADRESY = A.ID_ADRESY
    JOIN SMEROVACI_CISLA SC ON A.PSC = SC.PSC
    JOIN OBCE O ON SC.ID_OBCE = O.ID_OBCE
    JOIN KRAJE K ON O.ID_KRAJE = K.ID_KRAJE
    JOIN TYPY_OBALU TOB ON V.ID_TYPU_OBALU = TOB.ID_TYPU_OBALU
    GROUP BY 
        K.ID_KRAJE,
        K.NAZEV,
        TRUNC(V.CAS_VYSTAVENI)
),
MaxVolumePerDayPerRegion AS (
    SELECT 
        ID_KRAJE,
        MAX(CELKOVY_OBJEM) AS MAX_OBJEM
    FROM 
        DailyVolumePerRegion
    GROUP BY 
        ID_KRAJE
)
SELECT 
    DVR.KRAJ,
    DVR.DEN,
    DVR.CELKOVY_OBJEM
FROM 
    DailyVolumePerRegion DVR
JOIN 
    MaxVolumePerDayPerRegion MVDPR ON DVR.ID_KRAJE = MVDPR.ID_KRAJE AND DVR.CELKOVY_OBJEM = MVDPR.MAX_OBJEM;

//Pro jednotlivé kraje určete pivovar z daného kraje, který vystavil největší objem piva
WITH TotalVolumePerBrewery AS (
    SELECT 
        KR.ID_KRAJE,
        KR.NAZEV AS KRAJ,
        PIV.ID_PIVOVARU,
        PIV.NAZEV AS PIVOVAR,
        SUM(V.POCET_KUSU * TOB.OBJEM_V_LITRECH) AS CELKOVY_OBJEM
    FROM 
        VYSTAV V
    JOIN PIVA PI ON V.ID_PIVA = PI.ID_PIVA
    JOIN PIVOVARY PIV ON PI.ID_PIVOVARU = PIV.ID_PIVOVARU
    JOIN ADRESY A ON PIV.ID_ADRESY = A.ID_ADRESY
    JOIN SMEROVACI_CISLA SC ON A.PSC = SC.PSC
    JOIN OBCE O ON SC.ID_OBCE = O.ID_OBCE
    JOIN KRAJE KR ON O.ID_KRAJE = KR.ID_KRAJE
    JOIN TYPY_OBALU TOB ON V.ID_TYPU_OBALU = TOB.ID_TYPU_OBALU
    GROUP BY 
        KR.ID_KRAJE,
        KR.NAZEV,
        PIV.ID_PIVOVARU,
        PIV.NAZEV
),
MaxVolumePerRegion AS (
    SELECT 
        ID_KRAJE,
        MAX(CELKOVY_OBJEM) AS MAX_OBJEM
    FROM 
        TotalVolumePerBrewery
    GROUP BY 
        ID_KRAJE
)
SELECT 
    TV.KRAJ,
    TV.PIVOVAR,
    TV.CELKOVY_OBJEM
FROM 
    TotalVolumePerBrewery TV
JOIN 
    MaxVolumePerRegion MR ON TV.ID_KRAJE = MR.ID_KRAJE AND TV.CELKOVY_OBJEM = MR.MAX_OBJEM;

//Pro jednotlivé světadíly určete nejprodávanější produkt (ten, kterého se celkově prodalo nejvíce).
WITH ProduktSvetadily AS (
    SELECT s.NAZEV AS SVETADIL, p.NAZEV AS PRODUKT, SUM(pr.CENA_CELKEM) AS CELKEM_PRODEJ
    FROM SVETADILY s
    JOIN ZEME z ON s.ID_SVETADILY = z.ID_SVETADILY
    JOIN PRODUKTY p ON z.ID_ZEME = p.ID_ZEME
    JOIN PRODEJE pr ON pr.ID_POBOCKY = (
        SELECT po.ID_POBOCKY
        FROM POBOCKY po
        JOIN ODDELENI o ON po.ID_POBOCKY = o.ID_POBOCKY
        WHERE o.ID_ODDELENI = (
            SELECT o2.ID_ODDELENI
            FROM ODDELENI o2
            JOIN PRODUKTY p2 ON o2.ID_ODDELENI = p2.ID_ZEME
            WHERE p2.ID_PRODUKTY = p.ID_PRODUKTY
        )
    )
    GROUP BY s.NAZEV, p.NAZEV
)
SELECT sv.SVETADIL, sv.PRODUKT, sv.CELKEM_PRODEJ
FROM ProduktSvetadily sv
JOIN (
    SELECT SVETADIL, MAX(CELKEM_PRODEJ) AS MAX_PRODEJ
    FROM ProduktSvetadily
    GROUP BY SVETADIL
) max_sv
ON sv.SVETADIL = max_sv.SVETADIL AND sv.CELKEM_PRODEJ = max_sv.MAX_PRODEJ
ORDER BY sv.SVETADIL;

//Vypište jihomoravské pivovary, které vaří alespoň 1 pivo s obsahem alkoholu vyšším než 6%
SELECT 
    PIVOVARY.NAZEV AS PIVOVAR
FROM 
    PIVOVARY
JOIN 
    ADRESY ON PIVOVARY.ID_ADRESY = ADRESY.ID_ADRESY
JOIN 
    SMEROVACI_CISLA ON ADRESY.PSC = SMEROVACI_CISLA.PSC
JOIN 
    OBCE ON SMEROVACI_CISLA.ID_OBCE = OBCE.ID_OBCE
JOIN 
    KRAJE ON OBCE.ID_KRAJE = KRAJE.ID_KRAJE
JOIN 
    PIVA ON PIVOVARY.ID_PIVOVARU = PIVA.ID_PIVOVARU
WHERE 
    KRAJE.NAZEV = 'Jihomoravský kraj'
    AND PIVA.ALKOHOL > 6;

//Pro všechny restaurace určete celkový počet vystavených sudů, ve kterých byl druh piva "tmavý ležák"
SELECT 
    RESTAURACE.NAZEV AS RESTAURACE,
    SUM(VYSTAV.POCET_KUSU) AS CELKOVY_POCET_SUDU
FROM 
    RESTAURACE
JOIN 
    VYSTAV ON RESTAURACE.ID_RESTAURACE = VYSTAV.ID_RESTAURACE
JOIN 
    PIVA ON VYSTAV.ID_PIVA = PIVA.ID_PIVA
JOIN 
    DRUHY_PIVA ON PIVA.ID_DRUHU_PIVA = DRUHY_PIVA.ID_DRUHU_PIVA
WHERE 
    DRUHY_PIVA.NAZEV = 'tmavý ležák'
GROUP BY 
    RESTAURACE.NAZEV;

//Pro jednotlivé kraje vyberte restaurace s největším počtem vystavených lahví v roce 2019.
WITH RESTAURACE_VYSTAV AS (
    SELECT 
        RESTAURACE.ID_RESTAURACE,
        RESTAURACE.NAZEV AS RESTAURACE_NAZEV,
        KRAJE.NAZEV AS KRAJ_NAZEV,
        SUM(VYSTAV.POCET_KUSU) AS POCET_LAHVI
    FROM 
        RESTAURACE
    JOIN 
        ADRESY ON RESTAURACE.ID_ADRESY = ADRESY.ID_ADRESY
    JOIN 
        SMEROVACI_CISLA ON ADRESY.PSC = SMEROVACI_CISLA.PSC
    JOIN 
        OBCE ON SMEROVACI_CISLA.ID_OBCE = OBCE.ID_OBCE
    JOIN 
        KRAJE ON OBCE.ID_KRAJE = KRAJE.ID_KRAJE
    JOIN 
        VYSTAV ON RESTAURACE.ID_RESTAURACE = VYSTAV.ID_RESTAURACE
    JOIN 
        TYPY_OBALU ON VYSTAV.ID_TYPU_OBALU = TYPY_OBALU.ID_TYPU_OBALU
    WHERE 
        EXTRACT(YEAR FROM VYSTAV.CAS_VYSTAVENI) = 2019
        AND TYPY_OBALU.NAZEV = 'láhev'
    GROUP BY 
        RESTAURACE.ID_RESTAURACE, RESTAURACE.NAZEV, KRAJE.NAZEV
)
SELECT 
    KRAJ_NAZEV,
    RESTAURACE_NAZEV,
    POCET_LAHVI
FROM (
    SELECT 
        KRAJ_NAZEV,
        RESTAURACE_NAZEV,
        POCET_LAHVI,
        ROW_NUMBER() OVER (PARTITION BY KRAJ_NAZEV ORDER BY POCET_LAHVI DESC) AS RN
    FROM 
        RESTAURACE_VYSTAV
)
WHERE 
    RN = 1;


